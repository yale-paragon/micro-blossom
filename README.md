# Distributed MWPM Decoder System

Distributed MWPM decoder for Quantum Error Correction

## Project Structure

- src: source code
  - fpga: the FPGA source code, including generator scripts
  - cpu: the CPU source code
- projects: Vivado projects


## Installation

For FPGA development and testing, we use [Verilator](https://verilator.org/guide/latest/install.html).
We pin to a specific version 5.014 to avoid incompatibility.

```sh
sudo apt install gtkwave
sudo apt install git help2man perl python3 make autoconf g++ flex bison ccache
sudo apt install libgoogle-perftools-dev numactl perl-doc
sudo apt-get install libfl2  # Ubuntu only (ignore if gives error)
sudo apt-get install libfl-dev  # Ubuntu only (ignore if gives error)
sudo apt-get install zlibc zlib1g zlib1g-dev  # Ubuntu only (ignore if gives error)

git clone https://github.com/verilator/verilator   # Only first time
cd verilator
git pull
git checkout v5.014      # pin to this specific version 

autoconf         # Create ./configure script
./configure      # Configure and create Makefile
make -j `nproc`  # Build Verilator itself (if error, try just 'make')
sudo make install
```

### Install VexRiscV

```sh
git clone git@github.com:SpinalHDL/VexRiscv.git --recursive
```

### Install OpenOCD for VexRiscV

I include the installation for both Ubuntu and MacOS. MacOS doesn't seem to work...: `Error: target 'fpga_spinal.cpu0' init failed`
when I run `openocd -c 'set VEXRISCV_YAML ../VexRiscv/cpu0.yaml' -f tcl/target/vexriscv_sim.cfg`.

**Update**: OpenOCD uses GDB instead of LLDB, but GDB does not support apple silicon, only x86. Thus, it is impossible to 
interactively debug the CPU with M1 Macs. However, the verilator and VexRiscV/SpinalHDL runs on M1 Macs without a problem.
We can debug the design on a x86 Linux machine and do other staffs on Macs.

```sh
git clone git@github.com:SpinalHDL/openocd_riscv.git
cd openocd_riscv

# for Ubuntu
sudo apt-get install libtool automake texinfo libusb-1.0-0-dev libusb-dev libyaml-dev pkg-config
# for MacOS (@Yue 2023.10.11)
brew install libtool automake libusb libyaml pkg-config texinfo

./bootstrap

# for Ubuntu
./configure --enable-ftdi --enable-dummy --enable-openjtag
# for MacOS (@Yue 2023.10.11, must enable openjtag for simulation)
LDFLAGS="-L/opt/homebrew/lib" CPPFLAGS="-I/opt/homebrew/include" ./configure --enable-ftdi --enable-dummy --disable-werror --enable-openjtag

make -j10
sudo make install
```

**Only on Linux** Simulation

```sh
# In the VexRiscv repository (`make run` should show `Boot` and then hang there until the OpenOCD is connected)
sbt "runMain vexriscv.demo.GenFull"
cd src/test/cpp/regression
make run DEBUG_PLUGIN_EXTERNAL=yes

# In the openocd repository, after building it =>
src/openocd -c "set VEXRISCV_YAML ../VexRiscv/cpu0.yaml" -f tcl/target/vexriscv_sim.cfg

# Run GDB session
riscv32-unknown-elf-gdb VexRiscvRepo/src/test/resources/elf/uart.elf
target remote localhost:3333
monitor reset halt
load
continue
# then a sequence of messages should be print to the first terminal
```

## Build



## Known Issues

The reset signal generated by SpinalHDL is asynchronous reset.
Need to specify the clock domain in the top level design to make it synchronous.

I wanted to use the latest Scala but it doesn't seem to be compatible with VexRiscV code base.
Official VexRiscV uses Scala 2.11.12, but in this project I want to use `circe` which requires at least 2.12 or 2.13.
I tried to bump up the VexRiscV version to 2.13.12 but it shows a lot of errors.
Bumping to 2.12.12 is fine, so we can stay here for a while.
The updated repo is at [git@github.com:yuewuo/VexRiscv.git](git@github.com:yuewuo/VexRiscv.git).
The tested commands are: 

```sh
sbt "runMain vexriscv.demo.Briey"  # try to build briey
VEXRISCV_REGRESSION_SEED=42 VEXRISCV_REGRESSION_LINUX_REGRESSION=no VEXRISCV_REGRESSION_ZEPHYR_COUNT=0 sbt "testOnly vexriscv.TestIndividualFeatures"
```
